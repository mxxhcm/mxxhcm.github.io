---
title: virtual memory csapp
date: 2019-12-17 02:55:10
tags:
 - 操作系统
 - 计算机系统
categories: 计算机系统
---


## 物理和虚拟寻址
计算机系统的主存被组织成一个由M个连续的字节数组，每字节都有一个唯一的**物理地址**。物理寻址：CPU使用物理地址访问主存。
早期PC使用物理寻址，现代处理器使用虚拟寻址。通过虚拟寻址，CPU通过一个虚拟地址访问主存，这个虚拟地址在送到内存前被转换成适当的物理地址。实现地址翻译的是内存管理单元(MMU)。


## 地址空间
地址空间是一个非负整数地址的集合，如果地址空间是连续的，**叫做线性地址空间**。
带有虚拟内存的系统，CPU从一个有N个地址的地址空间中生成**虚拟地址**，这个地址空间称为**虚拟地址空间**：{0,1,..., N-1}，N一般是2的n次幂（n为32或者64)，也叫做n位地址空间。
这个系统还需要还有一个**物理地址空间**，对应系统中物理内存的M个字节：{0,1,...,M-1}。M不要求是2的幂，但是一般假设M是2的m次幂。

地址空间区分了数据对象（字节）和它们的属性（地址）。允许每个数据对象有多个独立的地址，比如主存中的每个字节可能有一个虚拟地址，也有一个物理地址。

## 虚拟内存作为缓存的工具
**虚拟内存可以用来缓存更大的虚拟地址空间的页面。**
从概念上而言，**虚拟内存被组织为一个由存放在磁盘上的N个连续的字节大小的单元组成的数组**。每个字节都有一个唯一的虚拟地址，作为数组的索引。磁盘上数组的内容被缓存在主存中。
虚拟内存系统将虚拟内存分割成虚拟页(VP)，虚拟页存储在磁盘上。物理内存被分割成物理页(PP，也叫页帧)，物理页缓存在DRAM上。他们的大小都为P字节。

虚拟页面的集合被分为三个不相交的子集：
1. 未分配的。虚拟内存系统还没有创建或者分配的页，未分配的块没有任何数据和他们相关联，也就不占用磁盘空间。
2. 缓存的。已经缓存在物理内存中的已分配页。
3. 未缓存的。未缓存在物理内存中的已分配页。

### DRAM缓存的组织结构
DRAM缓存表示虚拟内存系统的缓存，它在主存中缓存虚拟页。
SRAM缓存表示CPU和主存之间的L1, L2, L3高速缓存。
DRAM缓存的不命中率要比SRAM中的不命中昂贵的多，因为DRAM不命中，需要磁盘提供服务，而SRAM不命中需要DRAM提供服务。而DRAM比SRAM慢10倍，而磁盘比DRAM慢10万倍。而且从磁盘的第一个扇区读取第一个字节的时间开销比起读这个扇区中的连续字节要慢10万被。
因为大的不命中处罚和访问第一个字节的开销，虚拟页往往很大，通过是4KB到2MB。优于大的不命中处罚，DRAM缓存是全相连的，任何虚拟页都可以放置在任何物理页中。

### 页表
页表是一个数据结构，它和操作系统，MMU（内存管理单元中的）地址翻译硬件，一起提供了虚拟页的缓存的查找（当前虚拟页是否缓存在某个物理页中）和替换（如果不在替换哪个）等。
页表是一个常驻的主存，它是一个页表条目(page table entry)的数组，虚拟地址空间中的每个页在页表中都有一个PTE。假设PTE是由一个有效位和n位地址空间组成的，如果设置了有效位，地址指向物理页的起始位置，如果没有设置有效位，地址指向虚拟页在磁盘上的起始位置。

### 页命中和缺页
DRAM缓存不命中称为缺页page fault，命中叫做页命中。

1. 如果想要读取某个字，地址翻译硬件根据虚拟地址查找页表，然后找到一个页表项
2. 如果页表项标记当前页被缓存了，地址翻译硬件根据PTE中的物理内存地址构造这个字的物理地址，返回。
3. 如果页表项标记当前页没有被缓存，触发缺页异常，调用内核的缺页异常处理程序，选择一个物理页中的内存进行替换。
替换的内容：将替换页的更新写入磁盘，以及将替换页的页表条目更新为没有缓存。将访问页从磁盘复制到主存，更新该页相应的页表项。异常处理程序返回时会重新启动导致缺页的指令，这个指令把缺页的虚拟地址重新发送到地址翻译硬件。接下来就相当于执行步骤2。

页面调度（交换）是指在磁盘和内存之间传送页的活动。
直到有不命中发生时，才进行页面调入（换入）和页面调出（换出）的策略叫做按需页面调度。

### 分配页面
比如调用malloc就会触发分配页面的操作：在磁盘上分配空间，然后它们映射到物理内存中的物理页面，并更新相应的页表项。

### 局部性和抖动
局部性使得虚拟内存的性能很好。尽管在整个运行过程中引用的不同页面总数可能超过物理内存的大小，但是局部性保证了在任意时刻，程序趋向于在一个较小的活动页面集合上工作，这个集合叫做工作集或者常驻集合。
不过，当工作集的大小超过物理内存的大小时，就会发生抖动（即页面不断的被换进换出）。

## 虚拟内存作为内存管理的工具
操作系统为每个进程都提供了一个独立的页表，也就是一个独立的地址空间。多个虚拟页面可以映射到同一个物理页面。
按需页面调度和独立的虚拟地址空间结合，有很多好处：
1. 简化链接。
2. 简化加载。
3. 简化共享。
4. 简化内存分配。

## 虚拟内存作为内存保护的工具
虚拟内存通过在页表项中添加SUP，READ，WRITE等字段，控制进程的权限。设置SUP位，表示只有内核进程可以访问页面，否则就没有权限。
违反了条件，就会触发Segmentation fault。

## 地址翻译
形式上来说，地址翻译是一个N元素的虚拟地址空间(Virtual Adress Space)中的元素和一个M元素的物理地址空间(Phicias Adress Space)中元素之间的映射。

CPU的页表基址寄存器（Page table base register, PTBR)指向当前页表。n位的地址空间包含两部分，一个是p位的虚拟页面偏移(virtual page offset, VPO)，一个是n-p位的虚拟页号(Virtual Page Number, VPN)。

物理和虚拟页面都是P字节的，所以VPO和PPO是相同的。

### 结合高速缓存和虚拟内存
### 利用TLB加速地址翻译
### 多级页表
### 端到端的地址翻译


## Intel Core i7/Linux 内存系统

## 内存映射
Linux通过将一个虚拟内存区域和磁盘上的对象关联起来，初始化这个虚拟内存区域中的内容，这个过程叫做内存映射(memory mapping)。

### 再看共享对象
### 再看fork函数
### 再看execve函数

### 使用mmap函数的用户级内存映射

## 动态内存分配
### malloc和free

### 为什么要使用动态内存分配

### 分配器的要求和目标

### 碎片
### 实现问题
### 隐式空闲链表
### 放置已分配的块
### 分隔空闲块
### 获取额外的堆内存
### 合并空闲块

### 带边界标记的合并
### 实现一个简单的分配器

### 显式空闲链表
### 分离的空闲链表

## 垃圾收集

### 基本知识
### Mark和Sweep垃圾收集器
### C程序的保守Mark和Sweep

## C中常见的内存相关错误
### 解引用坏指针

### 读取未初始化的内存

### 允许栈缓冲区溢出

### 假设指针和它们指向的对象是相同大小的

### 造成错位错误

### 引用指针，而不是它所指向的对象
### 误解引用指针
### 引用不存在的变量
### 引用空闲堆块中的数据
### 引起内存泄露

## 参考文献
1.《CSAPP》
